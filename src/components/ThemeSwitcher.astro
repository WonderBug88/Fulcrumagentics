---
/**
 * ThemeSwitcher.astro
 * Token theme toggle (system/light/dark).
 * Uses <html class="theme-light"> / <html class="theme-dark">
 * Stores preference in localStorage "fa-theme" as: 'light' | 'dark' | 'system'
 */
---

<div class="flex items-center gap-2">
  <span
    id="faThemeLabel"
    class="hidden sm:inline text-xs"
    style="color: var(--color-text-muted);"
  >
    Day
  </span>

  <button
    id="faThemeToggle"
    class="theme-toggle"
    type="button"
    aria-label="Toggle theme"
    title="Toggle theme"
    data-mode="system"
    aria-pressed="false"
  >
    <span class="theme-toggle__icon" aria-hidden="true">☀</span>

    <span class="theme-toggle__track" aria-hidden="true">
      <span class="theme-toggle__knob"></span>
    </span>

    <span class="theme-toggle__icon" aria-hidden="true">☾</span>
  </button>

  <script is:inline>
    (() => {
      const key = "fa-theme"; // 'light' | 'dark' | 'system'
      const root = document.documentElement;
      const btn = document.getElementById("faThemeToggle");
      const label = document.getElementById("faThemeLabel");

      if (!btn) return;

      const prefersDark = () =>
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      const getSaved = () => {
        try {
          return localStorage.getItem(key) || "system";
        } catch {
          return "system";
        }
      };

      const apply = (saved) => {
        const effective =
          saved === "system" ? (prefersDark() ? "dark" : "light") : saved;

        root.classList.remove("theme-light", "theme-dark");
        root.classList.add(effective === "dark" ? "theme-dark" : "theme-light");

        btn.setAttribute("data-mode", saved);
        btn.setAttribute("aria-pressed", String(effective === "dark"));
        if (label) label.textContent = effective === "dark" ? "Night" : "Day";
      };

      const setSaved = (v) => {
        try { localStorage.setItem(key, v); } catch {}
        apply(v);
      };

      // Cycle: system -> light -> dark -> system
      const nextMode = (current) => {
        if (current === "system") return "light";
        if (current === "light") return "dark";
        return "system";
      };

      // Init
      apply(getSaved());

      // Click
      btn.addEventListener("click", () => {
        setSaved(nextMode(getSaved()));
      });

      // React to OS changes if in system mode
      try {
        const mql = window.matchMedia("(prefers-color-scheme: dark)");
        const onChange = () => {
          if (getSaved() === "system") apply("system");
        };
        if (mql.addEventListener) mql.addEventListener("change", onChange);
        else if (mql.addListener) mql.addListener(onChange);
      } catch {}

      // Sync across tabs
      window.addEventListener("storage", (e) => {
        if (e.key === key) apply(getSaved());
      });
    })();
  </script>
</div>
